<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stackgazer</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🔍%3C/text%3E%3C/svg%3E">    
  <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="stackgazer"></div>
    <script type="module" src="./index.ts"></script>
    <script>
        // Initialize the app (StackgazerApp is made available globally by the bundled code)
        document.addEventListener('DOMContentLoaded', function() {
            // Add custom settings here.
            const app = new window.StackgazerApp("stackgazer", defaults => {
                return {
                    ...defaults,
                functionTrimPrefixes: ['github.com/cockroachdb/cockroach/pkg/'],
                fileTrimPrefixes: [
                    'bazel-out/k8-opt/bin/pkg/.*_go_proto_/', 
                    'github.com/cockroachdb/cockroach/'
                ],
                categorySkipRules: [
                    ...defaults.categorySkipRules,
                        'google.golang.org/grpc',
                        'util/stop', 'util/ctxgroup',    
                        'jobs.(*Registry).resumeJob',
                        'jobs.(*Registry).runJob',
                        'jobs.(*Registry).stepThroughStateMachine',
                        'kv/kvclient/rangefeed.(*RangeFeed).run', 
                        'kv/kvpb._', 
                        'rpc.NewServerEx',  
                        'rpc.internalClientAdapter', 
                        'rpc.makeInternalClientAdapter', 
                        'rpc.serverStreamInterceptorsChain', 
                        'rpc.kvAuth', 
                        'sql/flowinfra.(*FlowBase).StartInternal.func', 
                        'sql/execinfra.(*ProcessorBaseNoHelper).Run', 
                        'sql/execinfra.Run'
                ],
                nameSkipRules: [
                    ...defaults.nameSkipRules,
                        'rpc.NewContext.ClientInterceptor.func8',
                        'kv/bulk.(*CPUPacer).Pace',
                        'util/cidr.metricsConn.Read',
                        'server.(*Node).batchInternal'
                    ],
                nameFoldRules: [
                    ...defaults.nameFoldRules,
                    's|util/ctxgroup.Group.Wait,|waitgroup|',
                    's|util/ctxgroup.GroupWorkers,|waitgroup|',
                    's|util/ctxgroup.GoAndWait,|waitgroup|',
                    's|util/admission.(*WorkQueue).Admit,^(util/admission|kv/kvserver/kvadmission)|AC|',
                ],
                nameFindRules: [
                    ...defaults.nameFindRules,
                    's|kv/kvclient/kvcoord.(*DistSender).Send,^(kv/kvclient/kvcoord|kv\\.)|DistSender|',
                ],
                nameExtractionPatterns: [
                    ...defaults.nameExtractionPatterns,
                    's|pgwire\\.\\(\\*Server\\)\\.serveImpl.*?\\{0x1,\\s*0x2,\\s*\\{0x([0-9a-fA-F]+),|hex:n$1|',
                    's|pgwire\\.\\(\\*Server\\)\\.serveImpl.*?\\{0x0,\\s*0x4,\\s*\\{0x([0-9a-fA-F]+),|hex:n$1|',
                    's|# labels:.*?"n":"([0-9]+)"|n$1|',
                    's|tags=([^,\\s]+)|$1|',
                ]
                };
            });
            window.app = app;
            console.log('Stackgazer loaded: go ahead, gaze into the abyss.');
        });
    </script>
</body>

</html>